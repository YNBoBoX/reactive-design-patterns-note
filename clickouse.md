# 什么是ClickHouse

ClickHouse是**俄罗斯**的Yandex于**2016年**开源的**列式存储数据库RDBMS**，主要用于**在线分析处理查询OLAP**，能够使用SQL查询实时生成分析数据报告。R

## 什么是列式存储

以一张表为例子

| id   | name | age  |
| ---- | ---- | ---- |
| 1    | 张三 | 18   |
| 2    | 李四 | 22   |
| 3    | 王五 | 34   |

采用**行式存储**时，数据在磁盘上的组织结构为

| 1    | 张三 | 18   | 2    | 李四 | 22   | 3    | 王五 | 34   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |      |      |      |      |

查找某个人的所有属性的时候，可以通过一次磁盘查找加顺序读取就可以了。

但是想查所有人的年龄时，需要不停的查找，或者全表扫描。

而采用列式存储时，数据在磁盘上的组织结构为：

| 1    | 2    | 3    | 张三 | 李四 | 王五 | 18   | 22   | 34   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |      |      |      |      |

想查所有人的年龄时，只需要把年龄那一列拿出来就可以了。

# 表引擎

## TinyLog

最简单的表引擎

1. 存在磁盘中
2. 不支持索引
3. 没有并发控制，没有对并发进行优化，但是支持并发，同时读（没问题），同时写（数据损坏），同时读写（报错）。应用场景，很多小表数据导入后只是查询，不会进行修改。

## Memory

内存引擎，数据以未压缩的原始形态直接保存在内存，服务器重启数据就会消失。特点就是快，简单查询下超过10G/s。

应用场景：除了用来测试，就是需要非常高性能，同时数据量又不太大（上线大概1亿行）的场景。

## Merge

Merge引擎本身不存数据，但可用于同时从任意多个其他的表中读取数据。读时自动并行的，不支持写入。读取时，那些被真正读取到数据的表的索引（如果有的话）会被使用。

参数：一个数据库名和一个用于匹配表名的正则表达式

## MergeTree（重点）

合并树，当你有巨量数据要插入到表中，你要高效地一批批写入数据片段，并希望这些数据片段在后台按照一定规则合并。相比在插入时不断修改（重写），这样的策略更加高效：

* 数据按主键排序
* 可以使用分区（如果指定了主键）
* 支持数据副本
* 支持数据采样

SETTINGS：影响MergeTree性能的额外参数：

1. index_granularity,索引粒度，默认值8192，索引中相邻标记之间的数据行数

2. use_minimalistic_part_header_in_zookeeper,数据片段头在ZooKeeper中的存储方式

3. min_merge_bytes_to_use_direct_io,直接使用I/O来操作磁盘的合并操作时要求的最小数据量

## ReplacingMergeTree

这个引擎只是在MergeTree的基础上，添加了“处理重复数据”的功能，它会删除具有相同主键的重复项，数据去重只在合并的过程出现，会在未知的时间在后台进行，所以无法预先作出计划，而且可能有些数据仍未被处理。

使用场景：后台清除重复的数据以节省空间，不保证完全去重。

## SummingMergeTree

继承MergeTree，区别在于，当合并SummingMergeTree表的数据片段时，ClickHouse会把所有具有相同主键的行合并为一行，该行包含了被合并的行中具有数值数据类型的列的汇总值，如果主键的组合方式使得单个键值对应于大量的行，则可以显著减少存储空间并加快数据查询速度，对于不可加的列，会取一个最先出现的值。

## Distributed（重点）

分布式引擎，本身不存储数据，但可以在多个服务器上进行分布式查询。读时自动并行的，读取时，远程服务器表的索引（如果有的话）会被使用。

Distributed(cluster_name,database,table [,sharding_key])

式中：

* cluster_name-服务器配置文件中的集群名，/etc/metrika.xml



